/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model combined with shared access for collaborative entities like subscriptions and messages. The primary goal is to isolate user data and ensure that users can only access information they own, they created, or that has been explicitly shared with them. It also includes specific rules for administrative roles.
 *
 * Data Structure: The data is organized into several top-level collections: `/users`, `/conversations`, `/moderation-actions`, `/transactions`, `/tasks`, and `/ops_messages`.
 *
 * Key Security Decisions:
 * - Role-Based Access: Specific collections like `/moderation-actions`, `/tasks`, and `/ops_messages` are restricted to users with `admin`, `moderateur`, or `agence` roles.
 * - Ownership-Based Writes: All write operations are strictly controlled by ownership checks.
 * - Secure Private Data: Collections containing sensitive or private user data have list operations disabled to prevent data leakage.
 *
 * Denormalization for Authorization: The rules rely on denormalized IDs within documents to make authorization decisions (e.g., `participantIds` in conversations).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }
    
    function isTeamMember() {
        let userRole = getUserRole(request.auth.uid);
        return isSignedIn() && userRole in ['admin', 'moderateur', 'agence'];
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------
    match /users/{userId} {
      allow get: if true;
      allow list: if isTeamMember();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) || isTeamMember();
      allow delete: if isTeamMember();

      // Only the user can access their own saved content and subscriptions
      allow read, write: if isOwner(userId);
    }

    match /conversations/{conversationId} {
        allow read, write: if isSignedIn() && request.auth.uid in resource.data.participantIds;
        allow create: if isSignedIn() && request.auth.uid in request.resource.data.participantIds;
    }

    match /conversations/{conversationId}/messages/{messageId} {
      // Only participants of the conversation can read/write messages
      allow read, write: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds;

      // When creating a message, plaintext can only be written if it's for the sender
      allow create: if request.resource.data.senderId == request.auth.uid;
    }

    match /moderation-actions/{actionId} {
      allow read, list: if isTeamMember();
      allow create: if isTeamMember() && request.resource.data.moderatorId == request.auth.uid;
      allow update, delete: if isTeamMember() && getUserRole(request.auth.uid) == 'admin';
    }

    match /transactions/{transactionId} {
        allow read: if isTeamMember() || isOwner(resource.data.subscriberId) || isOwner(resource.data.creatorId);
        allow list: if isTeamMember();
        allow create: if isSignedIn(); // Simplified for now, server-side validation is better
        allow update, delete: if false; // Transactions should be immutable
    }
    
    match /tasks/{taskId} {
        allow read, list, create, update, delete: if isTeamMember();
    }
    
    match /ops_messages/{messageId} {
        allow read, list: if isTeamMember();
        allow create: if isTeamMember() && request.resource.data.senderId == request.auth.uid;
        allow update, delete: if isTeamMember() && (isOwner(resource.data.senderId) || getUserRole(request.auth.uid) == 'admin');
    }
  }
}
